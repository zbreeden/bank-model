<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Bank ‚Äî Executive Delivery Scorecard</title>
  <meta name="description" content="A lightweight, executive-ready delivery scorecard for GECU built on flow signals: WIP, Throughput, Lead/Cycle Time, On‚ÄëTime %, Defect Escape, Aging WIP." />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root { --fg:#111; --bg:#fff; --muted:#6b7280; --card:#f8fafc; --border:#e5e7eb; }
    @media (prefers-color-scheme: dark){ :root{ --fg:#e5e7eb; --bg:#0b0f14; --muted:#9aa3af; --card:#121820; --border:#223042; } }
    *{ box-sizing:border-box; }
    body{ margin:0; font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color:var(--fg); background:var(--bg); }
    header{ padding:24px 16px; border-bottom:1px solid var(--border); position:sticky; top:0; backdrop-filter:saturate(180%) blur(6px); background:color-mix(in oklab, var(--bg) 85%, transparent); z-index:20; }
    .wrap{ max-width:1100px; margin:0 auto; }
    h1{ font-size:22px; margin:0 0 4px; }
    .sub{ color:var(--muted); font-size:14px; }
    .grid{ display:grid; grid-template-columns: repeat(6, 1fr); gap:12px; }
    @media (max-width:1000px){ .grid{ grid-template-columns: repeat(3,1fr);} }
    @media (max-width:640px){ .grid{ grid-template-columns: repeat(2,1fr);} }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; }
    .kpi h3{ font-size:12px; margin:0; color:var(--muted);} 
    .kpi .v{ font-size:24px; font-weight:700; margin-top:6px; }
    .kpi .s{ font-size:12px; color:var(--muted); }
    section{ padding:16px; }
    h2{ font-size:16px; margin:0 0 12px; }
    canvas{ width:100% !important; height:360px !important; }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width:960px){ .row{ grid-template-columns:1fr; }}
    .table{ width:100%; border-collapse:collapse; font-size:14px; }
    .table th,.table td{ padding:8px 10px; border-top:1px solid var(--border);} 
    .muted{ color:var(--muted); }
    .badge{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border); font-size:12px; }
    footer{ padding:24px 16px; color:var(--muted); font-size:12px; }
    .ok{ color:#16a34a; } .warn{ color:#eab308; } .risk{ color:#dc2626; }
  </style>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>üè¶ The Bank ‚Äî Executive Delivery Scorecard</h1>
      <div class="sub">Flow signals for predictable delivery ¬∑ <span id="updated" class="muted">loading‚Ä¶</span></div>
    </div>
  </header>

  <main class="wrap">
    <!-- KPI GRID -->
    <section>
      <div class="grid" id="kpis">
        <!-- Populated by JS -->
      </div>
    </section>

    <!-- CHARTS -->
    <section class="row">
      <div class="card">
        <h2>Inflow vs Throughput vs WIP (last 12 weeks)</h2>
        <canvas id="chartFlow"></canvas>
      </div>
      <div class="card">
        <h2>Lead Time (days) & On‚ÄëTime % (last 12 weeks)</h2>
        <canvas id="chartQuality"></canvas>
      </div>
    </section>

    <!-- CAPACITY vs DEMAND + RISKS -->
    <section class="row">
      <div class="card">
        <h2>Capacity vs Demand ‚Äî This Week</h2>
        <table class="table" id="capTable">
          <thead><tr><th>Capacity (slots)</th><th>Demand (new requests)</th><th>Load vs Capacity</th></tr></thead>
          <tbody></tbody>
        </table>
        <p class="muted" style="margin-top:8px">Goal: Throughput ‚â• Demand ¬∑ Keep WIP under cap.</p>
      </div>
      <div class="card">
        <h2>Risks & Actions ‚Äî This Week</h2>
        <ul id="risks" class="muted" style="margin:0; padding-left:18px"></ul>
      </div>
    </section>

    <section class="card">
      <h2>Definitions</h2>
      <p class="muted">WIP ‚Äî items in progress ¬∑ Throughput ‚Äî finished/week ¬∑ Lead Time ‚Äî request‚Üídone (median days) ¬∑ On‚ÄëTime % ‚Äî delivered by commit date ¬∑ Defect Escape ‚Äî prod‚Äëfound/total ¬∑ Aging WIP ‚Äî in‚Äëprogress items &gt; 10 days.</p>
      <p class="muted">Audit notes: delivery metadata only (no member PII); weekly CSV + PDF recommended.</p>
    </section>
  </main>

  <footer class="wrap">Made for GECU panel preview. Drop <code>data/bank_scorecard.csv</code> into this repo or point to a raw URL in the config.</footer>

  <script>
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // CONFIG ‚Äî set these to point at your GitHub repo CSV
  // Option A: Use local CSV in /data (works on GitHub Pages when file is committed)
  const USE_LOCAL = true;                 // set false to fetch from another repo
  const LOCAL_PATH = 'data/bank_scorecard.csv';

  // Option B: Raw GitHub CSV (if hosted in another repo)
  const GITHUB = { owner: 'zbreeden', repo: 'bank-model', branch: 'main', path: 'data/bank_scorecard.csv' };
  const RAW_URL = `https://raw.githubusercontent.com/${GITHUB.owner}/${GITHUB.repo}/${GITHUB.branch}/${GITHUB.path}`;

  // Domain parameters
  const WIP_CAP = 20; // team policy example ‚Äî show visually on chart

  // Utility: safe number formatters
  const fmt = new Intl.NumberFormat(undefined, { maximumFractionDigits: 0 });
  const pct = (v)=> (v==null? '‚Äî' : new Intl.NumberFormat(undefined, { style:'percent', maximumFractionDigits:1 }).format(v));

  async function loadCSV(url){
    const res = await fetch(url, { cache:'no-cache' });
    if(!res.ok) throw new Error('Fetch failed: '+res.status);
    const text = await res.text();
    // Simple CSV parser (no quoted commas in our file)
    const [header, ...lines] = text.trim().split(/\r?\n/);
    const cols = header.split(',').map(h=>h.trim());
    return lines.map(line=>{
      const vals = line.split(',');
      const row = {}; cols.forEach((c,i)=> row[c]=vals[i]!==undefined? vals[i].trim(): '' );
      // coerce types we expect
      ['inflow','throughput','wip_eow','lead_time_median_days','on_time_pct','defects_total','defects_escaped','aging_wip_gt_10d','demand','capacity_slots']
        .forEach(k=> row[k] = row[k]!==''? Number(row[k]): null);
      return row;
    });
  }

  function toSeries(rows){
    // Expect ascending time order; keep last 12
    const last = rows.slice(-12);
    const labels = last.map(r=> r.week_start);
    return {
      labels,
      inflow: last.map(r=> r.inflow),
      throughput: last.map(r=> r.throughput),
      wip: last.map(r=> r.wip_eow),
      lead: last.map(r=> r.lead_time_median_days),
      ontime: last.map(r=> r.on_time_pct),
      defectsTotal: last.map(r=> r.defects_total),
      defectsEsc: last.map(r=> r.defects_escaped),
      aging: last.map(r=> r.aging_wip_gt_10d),
      demand: last.map(r=> r.demand),
      capacity: last.map(r=> r.capacity_slots),
      latest: last[last.length-1]
    };
  }

  function el(html){ const d=document.createElement('div'); d.innerHTML=html.trim(); return d.firstChild; }

  function renderKPIs(s){
    const escRate = s.latest.defects_total? (s.latest.defects_escaped / s.latest.defects_total): 0;
    const kpis = [
      { label:'WIP (in progress)', value: fmt.format(s.latest.wip_eow) },
      { label:'Throughput (done/week)', value: fmt.format(s.latest.throughput) },
      { label:'Median Lead Time (days)', value: fmt.format(s.latest.lead_time_median_days) },
      { label:'On‚ÄëTime %', value: fmt.format(s.latest.on_time_pct) + '%' },
      { label:'Defect Escape', value: `${fmt.format(s.latest.defects_escaped)}/${fmt.format(s.latest.defects_total)} (${fmt.format(Math.round(escRate*100))}%)` },
      { label:'Aging WIP (>10d)', value: fmt.format(s.latest.aging_wip_gt_10d) }
    ];
    const grid = document.getElementById('kpis');
    grid.innerHTML = '';
    kpis.forEach(k=>{
      grid.appendChild(el(`<div class="card kpi"><h3>${k.label}</h3><div class="v">${k.value}</div></div>`));
    });
  }

  function renderCapacity(s){
    const tbody = document.querySelector('#capTable tbody');
    const cap = s.latest.capacity_slots; const dem = s.latest.demand;
    const load = cap? (dem/cap): 0; const cls = load<=0.9? 'ok' : (load<=1? 'warn':'risk');
    tbody.innerHTML = `<tr><td>${fmt.format(cap)}</td><td>${fmt.format(dem)}</td><td class="${cls}">${pct(load)}</td></tr>`;
  }

  function renderRisks(s){
    const items = [];
    if(s.latest.demand > s.latest.throughput){ items.push(`Backlog pressure: demand (${s.latest.demand}) exceeds throughput (${s.latest.throughput}). ‚Üí Action: review WIP, defer lower‚Äëvalue items, protect capacity.`); }
    if(s.latest.on_time_pct < 90){ items.push(`On‚ÄëTime below target (now ${s.latest.on_time_pct}%). ‚Üí Action: confirm commit dates, escalate blockers, trim WIP.`); }
    const escRate = s.latest.defects_total? (s.latest.defects_escaped/s.latest.defects_total): 0;
    if(escRate > 0.10){ items.push(`Quality risk: defect escape ${(escRate*100).toFixed(0)}%. ‚Üí Action: tighten Definition of Done/UAT checks.`); }
    if(s.latest.wip_eow > WIP_CAP){ items.push(`WIP above cap (${s.latest.wip_eow} > ${WIP_CAP}). ‚Üí Action: pause starts until aging items move.`); }
    if(items.length===0) items.push('No material risks detected this week. Keep WIP under cap and monitor aging WIP.');
    const ul = document.getElementById('risks');
    ul.innerHTML = items.map(t=>`<li>${t}</li>`).join('');
  }

  function chartFlow(ctx, s){
    const capLine = new Array(s.labels.length).fill(WIP_CAP);
    return new Chart(ctx, {
      type:'line',
      data:{ labels:s.labels, datasets:[
        { label:'Inflow', data:s.inflow, tension:0.25, borderWidth:2, pointRadius:0 },
        { label:'Throughput', data:s.throughput, tension:0.25, borderWidth:2, pointRadius:0 },
        { label:'WIP (EoW)', data:s.wip, tension:0.25, borderWidth:2, pointRadius:0 },
        { label:'WIP Cap', data:capLine, borderDash:[6,6], borderWidth:2, pointRadius:0 }
      ]},
      options:{
        interaction:{ mode:'index', intersect:false },
        plugins:{ legend:{ position:'bottom' } },
        scales:{ x:{ grid:{ display:false } }, y:{ beginAtZero:true } }
      }
    });
  }

  function chartQuality(ctx, s){
    return new Chart(ctx, {
      type:'line',
      data:{ labels:s.labels, datasets:[
        { label:'Lead Time (days)', data:s.lead, yAxisID:'y', tension:0.25, borderWidth:2, pointRadius:0 },
        { label:'On‚ÄëTime %', data:s.ontime, yAxisID:'y1', tension:0.25, borderWidth:2, pointRadius:0 }
      ]},
      options:{
        interaction:{ mode:'index', intersect:false },
        plugins:{ legend:{ position:'bottom' } },
        scales:{
          y:{ beginAtZero:true, title:{ display:true, text:'Days' } },
          y1:{ beginAtZero:true, min:70, max:100, position:'right', title:{ display:true, text:'%' }, grid:{ drawOnChartArea:false } },
          x:{ grid:{ display:false } }
        }
      }
    });
  }

  async function main(){
    const url = (USE_LOCAL? LOCAL_PATH : RAW_URL);
    const rows = await loadCSV(url).catch(async (e)=>{
      console.warn('Primary CSV fetch failed, falling back to embedded sample.', e);
      // Minimal fallback (8 weeks) if CSV missing ‚Äî replace by committing data/bank_scorecard.csv
      const sample = [
        {week_start:'2025-06-30', inflow:18, throughput:16, wip_eow:14, lead_time_median_days:11, on_time_pct:86, defects_total:6, defects_escaped:1, aging_wip_gt_10d:4, demand:18, capacity_slots:20},
        {week_start:'2025-07-07', inflow:17, throughput:17, wip_eow:13, lead_time_median_days:10, on_time_pct:88, defects_total:5, defects_escaped:1, aging_wip_gt_10d:3, demand:17, capacity_slots:20},
        {week_start:'2025-07-14', inflow:19, throughput:18, wip_eow:12, lead_time_median_days:10, on_time_pct:90, defects_total:4, defects_escaped:0, aging_wip_gt_10d:3, demand:19, capacity_slots:21},
        {week_start:'2025-07-21', inflow:20, throughput:18, wip_eow:14, lead_time_median_days:10, on_time_pct:89, defects_total:5, defects_escaped:1, aging_wip_gt_10d:4, demand:20, capacity_slots:19},
        {week_start:'2025-07-28', inflow:16, throughput:17, wip_eow:13, lead_time_median_days:9, on_time_pct:91, defects_total:4, defects_escaped:0, aging_wip_gt_10d:3, demand:16, capacity_slots:20},
        {week_start:'2025-08-04', inflow:18, throughput:19, wip_eow:12, lead_time_median_days:9, on_time_pct:92, defects_total:4, defects_escaped:0, aging_wip_gt_10d:2, demand:18, capacity_slots:20},
        {week_start:'2025-08-11', inflow:17, throughput:18, wip_eow:11, lead_time_median_days:8, on_time_pct:93, defects_total:3, defects_escaped:0, aging_wip_gt_10d:2, demand:17, capacity_slots:22},
        {week_start:'2025-08-18', inflow:18, throughput:19, wip_eow:10, lead_time_median_days:8, on_time_pct:94, defects_total:3, defects_escaped:0, aging_wip_gt_10d:2, demand:18, capacity_slots:20}
      ];
      return sample;
    });

    const s = toSeries(rows);
    renderKPIs(s);
    renderCapacity(s);
    renderRisks(s);
    document.getElementById('updated').textContent = `Week of ${s.latest.week_start}`;

    const fctx = document.getElementById('chartFlow').getContext('2d');
    chartFlow(fctx, s);
    const qctx = document.getElementById('chartQuality').getContext('2d');
    chartQuality(qctx, s);
  }

  window.addEventListener('DOMContentLoaded', main);
  </script>
</body>
</html>
